import{D as M}from"./base.CrPFMexR.js";class U extends M{constructor(){super(...arguments),this.tokenize=R}equals(p,i,d){return d.ignoreWhitespace?((!d.newlineIsToken||!p.includes(`
`))&&(p=p.trim()),(!d.newlineIsToken||!i.includes(`
`))&&(i=i.trim())):d.ignoreNewlineAtEof&&!d.newlineIsToken&&(p.endsWith(`
`)&&(p=p.slice(0,-1)),i.endsWith(`
`)&&(i=i.slice(0,-1))),super.equals(p,i,d)}}const j=new U;function z(x,p,i){return j.diff(x,p,i)}function R(x,p){p.stripTrailingCr&&(x=x.replace(/\r\n/g,`
`));const i=[],d=x.split(/(\n|\r\n)/);d[d.length-1]||d.pop();for(let S=0;S<d.length;S++){const N=d[S];S%2&&!p.newlineIsToken?i[i.length-1]+=N:i.push(N)}return i}(async function(){const x="fuwari-rss-store",i="posts",d="blog-posts-cache",S="new-post-list",C="/".replace(/^\/+|\/+$/g,"")||"root";function B(){return new Promise((n,u)=>{const t=indexedDB.open(x,3);t.onerror=()=>u(t.error),t.onsuccess=()=>n(t.result),t.onupgradeneeded=a=>{const s=a.target.result;if(s.objectStoreNames.contains(i)){a.target.transaction.objectStore(i).keyPath!=="id"&&(s.deleteObjectStore(i),s.createObjectStore(i,{keyPath:"id"}));return}s.createObjectStore(i,{keyPath:"id"})}})}function _(n,u){const t=(n||u||"").trim();if(!t)return"";try{const a=new URL(t,window.location.origin);return`${a.pathname}${a.search}${a.hash}`}catch{return t}}function A(n){return`${C}:${n}`}function $(n){return new Promise((u,t)=>{const e=n.transaction([i],"readonly").objectStore(i).getAll();e.onsuccess=()=>u(e.result),e.onerror=()=>t(e.error)})}function E(n,u){return new Promise((t,a)=>{const s=n.transaction([i],"readwrite"),e=s.objectStore(i);u.forEach(g=>{const r={...g,id:A(g.guid)};e.put(r)}),s.oncomplete=()=>t(),s.onerror=()=>a(s.error)})}async function O(){try{const u=await(await fetch("/rss.xml",{cache:"no-store"})).text(),a=new DOMParser().parseFromString(u,"text/xml");return Array.from(a.querySelectorAll("item")).map(e=>{const g=e.querySelector("title")?.textContent||"",r=(e.querySelector("link")?.textContent||"").trim(),f=(e.querySelector("guid")?.textContent||"").trim(),k=_(f||r,r),I=new Date(e.querySelector("pubDate")?.textContent||"").getTime(),m=e.querySelector("description")?.textContent||"",c=e.getElementsByTagNameNS("http://purl.org/rss/1.0/modules/content/","encoded")[0]?.textContent||e.getElementsByTagName("content:encoded")[0]?.textContent||e.querySelector("content")?.textContent||"";return{title:g,link:r,guid:k,pubDate:I,description:m,content:c}})}catch(n){return console.error("Failed to fetch RSS:",n),[]}}function P(n,u){if(!n||!u)return null;const t=r=>{const f=document.createElement("DIV");return f.innerHTML=r,f.textContent||f.innerText||""},a=t(n),s=t(u),e=z(a,s);return e.some(r=>r.added||r.removed)?e:null}function q(n){return n&&n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function y(n,u,t,a){const s=document.getElementById("notification-minimized"),e=document.getElementById("notification-panel"),g=document.getElementById(S),r=document.getElementById("notification-dot"),f=document.getElementById("minimize-notification"),k=document.getElementById("clear-notification"),I="fuwari-notification-state",m="fuwari-notification-init-time";if(!s||!e||!g)return;requestAnimationFrame(()=>{s.classList.remove("translate-y-20","opacity-0")});const o=new Date(a).toLocaleString(),c=new Date(u).toLocaleString();if(n.length===0){g.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                <p class="text-sm font-medium mb-2">暂无文章更新</p>
                <div class="text-xs opacity-70 bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 inline-block">
                    ${o} - ${c}
                </div>
             </div>`,r?.classList.add("hidden"),T();return}let b=`
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 px-1 flex flex-col gap-0.5">
                <div class="font-medium">发现更新</div>
                <div class="opacity-70 text-[10px]">${o} - ${c}</div>
            </div>`;n.forEach(l=>{const h=l.isUpdated,w=h?'<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-1.5 py-0.5 rounded ml-2">更新</span>':'<span class="text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 px-1.5 py-0.5 rounded ml-2">新文章</span>';let v="";const L="diff-"+l.guid.replace(/[^a-zA-Z0-9-_]/g,"_");h&&l.diff&&(v=`
                <button data-diff-toggle="${L}" class="ml-auto text-xs text-[var(--primary)] hover:underline focus:outline-none pointer-events-auto">
                    查看变更
                </button>`),b+=`
            <div class="mb-2 last:mb-0">
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--primary)]/5 transition-colors">
                    <a href="${l.link}" class="font-medium truncate pr-2 hover:text-[var(--primary)] transition-colors text-black dark:text-white block flex-1" target="_blank">
                        ${l.title}
                    </a>
                    <div class="flex items-center shrink-0">
                        ${v}
                        ${w}
                    </div>
                </div>
                ${h&&l.diff?`
                <div id="${L}" class="hidden mt-2 p-2 bg-gray-50 dark:bg-gray-800 rounded text-xs overflow-x-auto border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
                    ${l.diff.map(D=>`<div class="${D.added?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":D.removed?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":"text-gray-500 dark:text-gray-400 block my-1 p-1 break-all whitespace-pre-wrap"}">${q(D.value)}</div>`).join("")}
                </div>
                `:""}
            </div>`}),g.innerHTML=b,t?(r?.classList.remove("hidden"),setTimeout(()=>{openPanel()},1500)):r?.classList.add("hidden"),T();function T(){const l=()=>{e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0","scale-95")}),r?.classList.add("hidden")},h=()=>{e.classList.add("translate-y-4","opacity-0","scale-95"),setTimeout(()=>{e.classList.add("hidden")},300)};s.onclick=()=>{e.classList.contains("hidden")?l():h()},f.onclick=w=>{w.stopPropagation(),h(),setTimeout(()=>{s.classList.add("translate-y-20","opacity-0"),s.classList.add("pointer-events-none")},300)},k&&(k.onclick=w=>{w.stopPropagation(),localStorage.removeItem(I);const v=Date.now();localStorage.setItem(m,v.toString()),y([],v,!1,v)}),g.hasAttribute("data-listening")||(g.addEventListener("click",w=>{const v=w.target.closest("[data-diff-toggle]");if(v){const L=v.getAttribute("data-diff-toggle"),D=document.getElementById(L);D&&D.classList.toggle("hidden")}}),g.setAttribute("data-listening","true"))}window.toggleDiff=function(l){const h=document.getElementById(l);h&&h.classList.toggle("hidden")}}try{if(new URLSearchParams(window.location.search).has("debug-notification")){console.log("[Notification] Developer mode active"),y([{title:"Test New Post 1",link:"#",guid:"test-1",isUpdated:!1},{title:"Test Updated Post",link:"#",guid:"test-2",isUpdated:!0,diff:[{value:`This is some unchanged text context.
`,added:void 0,removed:void 0},{value:`This line was removed.
`,added:void 0,removed:!0},{value:`This line is new.
`,added:!0,removed:void 0},{value:`More unchanged text.
`,added:void 0,removed:void 0}]}],Date.now(),!0,Date.now());return}const t=await O();if(t.length===0)return;const a=await B(),s=await $(a),e="fuwari-notification-state",g="fuwari-notification-init-time";let r=localStorage.getItem(g);r||(r=Date.now().toString(),localStorage.setItem(g,r));const f=parseInt(r),k=localStorage.getItem(d);if(s.length===0&&k){console.log("[Notification] Migrating from localStorage..."),await E(a,t),localStorage.removeItem(d),y([],Date.now(),!1,f);return}if(s.length===0)await E(a,t),localStorage.removeItem(e),y([],Date.now(),!1,f);else{const I=new Map(s.map(o=>[o.id||A(o.guid||o.link||o.title),o])),m=[];if(t.forEach(o=>{const c=I.get(A(o.guid));if(!c)m.push({...o,isUpdated:!1});else{const b=o.title!==c.title,T=o.pubDate!==c.pubDate,l=o.description!==c.description,h=o.content!==c.content;if(b||T||l||h){let w=null;h?w=P(c.content,o.content):l?w=P(c.description,o.description):b&&(w=P(c.title,o.title)),m.push({...o,isUpdated:!0,diff:w})}}}),m.length>0){const o=m.length===t.length&&m.every(l=>!l.isUpdated),c=m.length===t.length&&m.every(l=>l.isUpdated);if(o||c){console.log('[Notification] Intercepted "all new/updated" posts scenario. Suppressing notification.'),await E(a,t),localStorage.removeItem(e),y([],Date.now(),!1,f);return}const b=Date.now(),T={timestamp:b,items:m};localStorage.setItem(e,JSON.stringify(T)),await E(a,t),y(m,b,!0,f)}else{const o=localStorage.getItem(e);if(o)try{const c=JSON.parse(o);y(c.items,c.timestamp,!1,f)}catch(c){console.error("Failed to parse notification state",c),y([],Date.now(),!1,f)}else y([],Date.now(),!1,f)}}}catch(n){console.error("New post check failed:",n)}})();
