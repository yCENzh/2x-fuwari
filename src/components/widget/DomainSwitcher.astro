---
import WidgetLayout from "./WidgetLayout.astro";
import { siteConfig } from "@/config";

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;

const officialSites = siteConfig.officialSites || [];
---
<WidgetLayout name="线路切换" id="domain-switcher" class={className} style={style}>
    <div class="flex flex-col gap-2">
        {officialSites.map((site) => {
            const urlStr = typeof site === 'string' ? site : site.url;
            const alias = typeof site === 'object' ? site.alias : null;
            let hostname = urlStr;
            try {
                hostname = new URL(urlStr).hostname;
            } catch (e) {
                // fallback to original string if not a valid URL
            }
            const displayName = alias || hostname;
            return (
                <a 
                    href={urlStr}
                    data-url={urlStr}
                    class="domain-link btn-regular !justify-between px-3 py-2 rounded-lg text-sm group"
                    data-domain={hostname}
                >
                    <span class="truncate">{displayName}</span>
                    <div class="flex items-center gap-2">
                        <span class="latency-text text-xs font-bold opacity-0 transition-opacity"></span>
                        <span class="status-indicator w-2 h-2 rounded-full bg-[var(--btn-content)]/30 dark:bg-white/30"></span>
                    </div>
                </a>
            );
        })}
    </div>
</WidgetLayout>

<script>
    function initDomainSwitcher() {
        const currentDomain = window.location.hostname;
        const links = document.querySelectorAll('.domain-link');
        
        links.forEach(link => {
            const domain = link.getAttribute('data-domain');
            const href = link.getAttribute('href');
            
            // Reset classes first
            link.className = 'domain-link btn-regular !justify-between px-3 py-2 rounded-lg text-sm group';
            
            const indicator = link.querySelector('.status-indicator');
            if (indicator) {
                indicator.className = 'status-indicator w-2 h-2 rounded-full bg-[var(--btn-content)]/30 dark:bg-white/30';
            }

            // Highlight current domain
            if (domain === currentDomain) {
                // Remove btn-regular to avoid style conflicts and apply active styles
                link.classList.remove('btn-regular');
                link.classList.add(
                    'flex', 'items-center', 'justify-between', // Restore layout styles from btn-regular/base
                    'bg-[var(--primary)]', 
                    'text-white', 
                    'dark:text-black/70',
                    'cursor-default'
                );
                
                if (indicator) {
                    indicator.classList.remove('bg-[var(--btn-content)]/30', 'dark:bg-white/30');
                    indicator.classList.add('bg-white', 'dark:bg-black/70');
                }
                
                link.removeAttribute('href'); 
            } else if (href) {
                // Update link to preserve current path
                try {
                    const url = new URL(href);
                    url.pathname = window.location.pathname;
                    url.search = window.location.search;
                    url.hash = window.location.hash;
                    link.setAttribute('href', url.toString());
                } catch (e) {
                    console.error('Invalid URL:', href);
                }
            }
        });
    }

    async function testLatency() {
        const links = document.querySelectorAll('.domain-link');
        for (const link of links) {
            const url = link.getAttribute('data-url');
            const latencyText = link.querySelector('.latency-text');
            const indicator = link.querySelector('.status-indicator');
            
            if (!url || !latencyText) continue;

            // Loading state
            latencyText.textContent = '...';
            latencyText.classList.remove('opacity-0', 'text-green-500', 'text-yellow-500', 'text-red-500');
            latencyText.classList.add('opacity-50');

            const start = performance.now();
            let latency = -1;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                await fetch(url, { 
                    method: 'HEAD',
                    mode: 'no-cors', 
                    cache: 'no-store',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const end = performance.now();
                latency = Math.round(end - start);
            } catch (e) {
                // Error or timeout
            }

            latencyText.classList.remove('opacity-50');
            
            const isActive = link.classList.contains('bg-[var(--primary)]');
            
            if (latency >= 0) {
                latencyText.textContent = `${latency}ms`;
                if (latency < 200) {
                    if (!isActive) {
                        latencyText.classList.add('text-green-600', 'dark:text-green-400');
                        if (indicator) {
                            indicator.classList.remove('bg-[var(--btn-content)]/30', 'dark:bg-white/30');
                            indicator.classList.add('bg-green-500');
                        }
                    }
                } else if (latency < 500) {
                    if (!isActive) {
                        latencyText.classList.add('text-yellow-600', 'dark:text-yellow-400');
                        if (indicator) {
                            indicator.classList.remove('bg-[var(--btn-content)]/30', 'dark:bg-white/30');
                            indicator.classList.add('bg-yellow-500');
                        }
                    }
                } else {
                    latencyText.classList.add('text-red-600', 'dark:text-red-400');
                    if (indicator && !isActive) {
                        indicator.classList.remove('bg-[var(--btn-content)]/30', 'dark:bg-white/30');
                        indicator.classList.add('bg-red-500');
                    }
                }
            } else {
                latencyText.textContent = '-';
                latencyText.classList.add('text-red-600', 'dark:text-red-400');
            }
        }
    }

    initDomainSwitcher();
    testLatency();
    document.addEventListener('astro:page-load', () => {
        initDomainSwitcher();
        testLatency();
    });
</script>


